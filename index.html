<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lending Tracker // Live</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --surface: rgba(23, 23, 23, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ededed;
            --text-muted: #888888;
            --accent: #ffffff;
            --danger: #ef4444;
            --font-family: 'Inter', -apple-system, sans-serif;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            
            /* Live Deep Background */
            background: linear-gradient(-45deg, #050505, #111111, #0f172a, #1a1a1a);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            max-width: 750px;
            position: relative;
        }

        /* --- New Header Layout --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 50px;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.02em;
        }
        .header-left p {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 6px;
        }

        /* --- Top Right Actions --- */
        .header-actions {
            display: flex;
            gap: 12px;
            position: relative;
        }

        .btn-header {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            backdrop-filter: blur(5px);
            font-weight: 500;
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Export Dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid var(--border);
            min-width: 140px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            border-radius: 8px;
            z-index: 10;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .dropdown-content a {
            color: var(--text-main);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-content a:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Show dropdown on hover */
        .dropdown:hover .dropdown-content { display: block; }

        input[type="file"] { display: none; }

        /* --- Total Display --- */
        .total-section {
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 40px;
        }
        .total-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }
        .total-amount {
            font-size: 3.5rem;
            font-weight: 500;
            letter-spacing: -0.03em;
            line-height: 1;
        }

        /* --- Input Form --- */
        .input-group {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 40px;
            align-items: center;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px 0;
            font-family: var(--font-family);
            font-size: 0.95rem;
            border-radius: 0;
            transition: border-color 0.2s;
        }
        
        input:focus { outline: none; border-bottom-color: var(--accent); }
        input::placeholder { color: #404040; }

        .btn-primary {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary.is-editing { background: #f59e0b; }

        .cancel-btn {
            display: none; background: transparent; border: none;
            color: var(--text-muted); cursor: pointer; font-size: 0.85rem;
        }
        .cancel-btn:hover { color: var(--text-main); }

        /* --- Search & List --- */
        .search-wrapper { position: relative; margin-bottom: 20px; }
        .search-icon {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); width: 16px; height: 16px;
        }
        .search-input { width: 100%; padding-left: 28px; font-size: 0.9rem; }

        .list-header {
            display: flex; justify-content: space-between; color: var(--text-muted);
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 16px; padding: 0 4px;
        }
        
        .reset-link {
            background: none; border: none; padding: 0;
            color: var(--text-muted); cursor: pointer; font-size: 0.75rem;
        }
        .reset-link:hover { color: var(--danger); }

        .item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 4px; border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }
        .item:hover { background: rgba(255,255,255,0.03); }

        .item-details h3 { font-size: 1rem; font-weight: 500; margin: 0 0 4px 0; color: var(--text-main); }
        .item-meta { font-size: 0.8rem; color: var(--text-muted); }

        .item-right { display: flex; align-items: center; gap: 20px; }
        .amount { font-weight: 500; font-size: 1rem; color: var(--text-main); }

        .icon-btn {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 4px; display: flex; align-items: center;
            opacity: 0.6; transition: opacity 0.2s, color 0.2s;
        }
        .icon-btn:hover { opacity: 1; color: var(--accent); }
        .icon-btn.delete:hover { color: var(--danger); }

        .empty-state { text-align: center; padding: 60px 0; color: var(--text-muted); font-size: 0.9rem; }
        svg { width: 18px; height: 18px; stroke-width: 2; }

        @media (max-width: 600px) {
            header { flex-direction: column; gap: 15px; }
            .header-actions { width: 100%; justify-content: flex-start; }
            .input-group { grid-template-columns: 1fr; gap: 16px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Lending Tracker</h1>
            <p>Live Minimalist Overview</p>
        </div>

        <!-- TOP RIGHT BUTTONS -->
        <div class="header-actions">
            <!-- Import Button -->
            <label for="fileInput" class="btn-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Import
            </label>
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .json">

            <!-- Export Dropdown -->
            <div class="dropdown">
                <button class="btn-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    Export
                </button>
                <div class="dropdown-content">
                    <a onclick="exportExcel()">Excel (.xlsx)</a>
                    <a onclick="exportCSV()">CSV (.csv)</a>
                    <a onclick="exportJSON()">JSON (.json)</a>
                </div>
            </div>
        </div>
    </header>

    <div class="total-section">
        <span class="total-label" id="totalLabel">Total Outstanding</span>
        <div class="total-amount" id="totalDisplay">₹0.00</div>
    </div>

    <!-- Input Form -->
    <form class="input-group" id="trackerForm">
        <input type="text" id="nameInput" placeholder="Name" required>
        <input type="text" id="purposeInput" placeholder="Purpose">
        <input type="text" id="amountInput" placeholder="Amount (e.g. 500+200)" required autocomplete="off">
        
        <div style="display:flex; gap:10px; align-items:center;">
            <button type="button" id="cancelEditBtn" class="cancel-btn">Cancel</button>
            <button type="submit" id="submitBtn" class="btn-primary">Add</button>
        </div>
    </form>

    <!-- Search -->
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="searchInput" class="search-input" placeholder="Filter by name...">
    </div>

    <!-- List -->
    <div class="list-header">
        <span>Transactions</span>
        <button class="reset-link" onclick="clearAllData()">Reset All</button>
    </div>
    <div id="listContainer"></div>
</div>

<script>
    // --- Elements ---
    const form = document.getElementById('trackerForm');
    const nameInput = document.getElementById('nameInput');
    const purposeInput = document.getElementById('purposeInput');
    const amountInput = document.getElementById('amountInput');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const listContainer = document.getElementById('listContainer');
    const totalDisplay = document.getElementById('totalDisplay');
    const totalLabel = document.getElementById('totalLabel');
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');

    let transactions = JSON.parse(localStorage.getItem('lendingData')) || [];
    let editingIndex = null; 

    // --- MATH LOGIC ---
    function calculateAmount(inputStr) {
        const sanitized = inputStr.replace(/[^0-9\+\-\*\/\.\(\)\s]/g, '');
        try {
            const result = new Function('return ' + sanitized)();
            return (typeof result === 'number' && !isNaN(result)) ? result : null;
        } catch (e) { return null; }
    }

    // --- IMPORT LOGIC ---
    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();

        // JSON
        if (fileName.endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        json.forEach(item => { if(item.name && item.amount) transactions.unshift(item); });
                        finishImport(json.length);
                    }
                } catch (err) { alert("Invalid JSON"); }
            };
            reader.readAsText(file);
        } 
        // Excel
        else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                processRowData(rows);
            };
            reader.readAsArrayBuffer(file);
        }
        // CSV
        else if (fileName.endsWith('.csv')) {
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) { processRowData(results.data); }
            });
        }
    });

    function processRowData(rows) {
        let count = 0;
        rows.forEach((row) => {
            let rawDate = row[0];
            let rawName = row[1];
            let rawAmount = row[2];
            let rawPurpose = row[3] || ""; 
            if(rawAmount) {
                let cleanAmount = String(rawAmount).replace(/[^0-9.-]+/g,"");
                let parsedAmount = parseFloat(cleanAmount);
                if (rawName && !isNaN(parsedAmount) && parsedAmount > 0) {
                    if(String(rawName).toLowerCase() !== 'name') {
                        transactions.unshift({
                            name: rawName,
                            amount: parsedAmount,
                            date: rawDate || new Date().toLocaleDateString('en-IN'),
                            purpose: rawPurpose
                        });
                        count++;
                    }
                }
            }
        });
        finishImport(count);
    }

    function finishImport(count) {
        saveAndRender();
        if(count > 0) alert(`Imported ${count} entries.`);
        fileInput.value = "";
    }

    // --- EXPORT LOGIC ---
    function exportExcel() {
        if(transactions.length === 0) return alert("No data.");
        const data = transactions.map(t => ({
            "Date": t.date,
            "Name": t.name,
            "Amount": t.amount,
            "Purpose": t.purpose || ""
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Lending Data");
        XLSX.writeFile(wb, "Lending_Tracker.xlsx");
    }

    function exportCSV() {
        if(transactions.length === 0) return alert("No data.");
        let csv = "Date,Name,Amount,Purpose\n";
        transactions.forEach(t => {
            let safeName = t.name.replace(/"/g, '""');
            let safePurpose = (t.purpose || "").replace(/"/g, '""');
            csv += `"${t.date}","${safeName}","${t.amount}","${safePurpose}"\n`;
        });
        downloadFile(csv, "Lending_Tracker.csv", "text/csv");
    }

    function exportJSON() {
        if(transactions.length === 0) return alert("No data.");
        const jsonStr = JSON.stringify(transactions, null, 2);
        downloadFile(jsonStr, "Lending_Tracker.json", "application/json");
    }

    function downloadFile(content, fileName, mimeType) {
        const blob = new Blob(["\uFEFF"+content], { type: mimeType + ";charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Render Logic ---
    function render() {
        listContainer.innerHTML = '';
        let filteredTotal = 0;
        let visibleCount = 0;
        const searchQuery = searchInput.value.toLowerCase().trim();

        if (transactions.length === 0) {
            listContainer.innerHTML = '<div class="empty-state">No transactions recorded.</div>';
            totalDisplay.innerText = formatINR(0);
            return;
        }

        transactions.forEach((t, index) => {
            if (t.name.toLowerCase().includes(searchQuery)) {
                filteredTotal += parseFloat(t.amount);
                visibleCount++;

                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div class="item-details">
                        <h3>${t.name}</h3>
                        <div class="item-meta">
                            ${t.date} ${t.purpose ? '• ' + t.purpose : ''}
                        </div>
                    </div>
                    <div class="item-right">
                        <span class="amount">${formatINR(t.amount)}</span>
                        <button class="icon-btn" onclick="startEdit(${index})" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="icon-btn delete" onclick="deleteItem(${index})" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(div);
            }
        });

        totalDisplay.innerText = formatINR(filteredTotal);
        if (searchQuery.length > 0) {
            totalLabel.innerText = `Total for "${searchInput.value}"`;
            if(visibleCount === 0) listContainer.innerHTML = '<div class="empty-state">No results.</div>';
        } else {
            totalLabel.innerText = "Total Outstanding";
        }
    }

    searchInput.addEventListener('input', render);

    function formatINR(num) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0 
        }).format(num);
    }

    // --- Form Logic ---
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const rawAmountStr = amountInput.value;
        const calculatedAmount = calculateAmount(rawAmountStr);

        if (calculatedAmount === null || calculatedAmount <= 0) {
            alert("Please check the amount.");
            return;
        }
        
        if (editingIndex !== null) {
            transactions[editingIndex].name = nameInput.value;
            transactions[editingIndex].purpose = purposeInput.value;
            transactions[editingIndex].amount = calculatedAmount;
            stopEditing();
        } else {
            const newTransaction = {
                name: nameInput.value,
                amount: calculatedAmount,
                date: new Date().toLocaleDateString('en-IN'),
                purpose: purposeInput.value
            };
            transactions.unshift(newTransaction);
        }
        saveAndRender();
        form.reset();
        nameInput.focus();
    });

    window.startEdit = (index) => {
        const item = transactions[index];
        nameInput.value = item.name;
        purposeInput.value = item.purpose || "";
        amountInput.value = item.amount;
        editingIndex = index;
        submitBtn.innerText = "Save";
        submitBtn.classList.add("is-editing");
        cancelEditBtn.style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
        amountInput.focus();
    };

    function stopEditing() {
        editingIndex = null;
        submitBtn.innerText = "Add";
        submitBtn.classList.remove("is-editing");
        cancelEditBtn.style.display = "none";
        form.reset();
    }
    cancelEditBtn.addEventListener('click', stopEditing);

    window.deleteItem = (index) => {
        if(editingIndex === index) stopEditing();
        if(confirm('Remove this entry?')) {
            transactions.splice(index, 1);
            saveAndRender();
        }
    };

    window.clearAllData = () => {
        if(confirm('This will delete all data. Continue?')) {
            transactions = [];
            stopEditing();
            saveAndRender();
        }
    };

    function saveAndRender() {
        localStorage.setItem('lendingData', JSON.stringify(transactions));
        render(); 
    }

    render();
</script>

</body>
</html>
